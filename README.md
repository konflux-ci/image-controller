# The Image Controller for AppStudio
The Image Controller for AppStudio helps set up container image repositories for AppStudio `Components`.

## Try it!

### Installation

1. Install the project on your cluster by running `make deploy`.
2. Set up the Quay.io token that would be used by the controller to setup image repositories under the `quay.io/redhat-user-workloads` organization.

```
kind: Secret
apiVersion: v1
metadata:
  name: quaytoken
  namespace: image-controller-system
data:
  organization: redhat-user-workloads
  quaytoken: redacted
type: Opaque
```


### Request image repository provision for a Component

To request the controller to setup an image repository, annotate the `Component` with `image.redhat.com/generate: 'true'`.


```
apiVersion: appstudio.redhat.com/v1alpha1
kind: Component
metadata:
  annotations:
    image.redhat.com/generate: 'true'
  name: billing
  namespace: image-controller-system
spec:
  application: city-transit
  componentName: billing
```

If `Component`'s auto-generated image repository should be deleted after component deletion, add `image.redhat.com/delete-image-repo` annotation to the `Component`.

### Update image repository token of the Component

To refresh image repository access token, set annotation `image.redhat.com/generate: 'regenerate-token'` on the Component.

### Verify

The `Image controller` would create the necessary resources on Quay.io and write out the details of the same into the `Component` resource as an annotation, namely:

* The image repository URL.
* The name of the Kubernets `Secret` in which the robot account name and token were written out to.

```
{
   "image":"quay.io/redhat-user-workloads/image-controller-system/city-transit/billing",
   "secret":"billing",
}
```

```
apiVersion: appstudio.redhat.com/v1alpha1
kind: Component
metadata:
  annotations:
    image.redhat.com/generate: 'false'
    image.redhat.com/image: >-
      {"image":"quay.io/redhat-user-workloads/image-controller-system/city-transit/billing","secret":"billing"
      }
  name: billing
  namespace: image-controller-system
  resourceVersion: '86424'
  uid: 0e0f30b6-d77e-406f-bfdf-5802db1447a4
spec:
  application: city-transit
  componentName: billing
```

The resulting secret specified in the `image.redhat.com/image` annotation is created by SPI.
To achive credentials storing on SPI side, Image Controller operator interacts with SPI in the following way:
1. Image Controller creates a short living secret named `<component-name>-upload-image-registry-secret` and marks it by `spi.appstudio.redhat.com/upload-secret=token` label.
2. SPI deletes the short-living secret right after its creation and in turn creates `SPIAccessToken` CR named the same as the generated by Image Controller robot account.
3. Image Controller sets owner reference of the token CR to the user's Component.
4. Image Controller creates `SPIAccessTokenBinding` CR named the same as token CR and sets the user's Component as its owner.
5. In response to the binding object, SPI creates resulting secret, which gets deleted when the corresponding binding gets deleted.
6. Image Controller puts the `image.redhat.com/image` annotation to the Component, reporting that the Component image repository provision is done.

Also, `image-controller.appstudio.openshift.io/image-repository` finalizer is used in order to garauntee clean up of the corresponding robot account and image repository (if requested).

## License

Copyright 2023.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

